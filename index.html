<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye Protection Schedule - Post C3R Care</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fafbfc;
            background-image: 
                linear-gradient(rgba(0,0,0,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.02) 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh;
            color: #2d3748;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        body.night-mode {
            background: #1a202c;
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            color: #e2e8f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: slideDown 0.8s ease-out;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        body.night-mode .header h1 {
            color: #e2e8f0;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        body.night-mode .header p {
            color: #a0aec0;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.06);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.8);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out;
        }

        body.night-mode .card {
            background: rgba(45,55,72,0.9);
            border: 1px solid rgba(74,85,104,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 16px 48px rgba(0,0,0,0.12);
        }

        body.night-mode .card:hover {
            box-shadow: 0 16px 48px rgba(0,0,0,0.4);
        }

        .card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body.night-mode .card h3 {
            color: #e2e8f0;
        }

        .icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        body.night-mode .timer-display {
            color: #90cdf4;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        body.night-mode .progress-bar {
            background: #4a5568;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
            animation: pulse 2s infinite;
        }

        body.night-mode .progress-fill {
            background: linear-gradient(90deg, #90cdf4, #63b3ed);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            position: relative;
            overflow: hidden;
        }

        body.night-mode .btn {
            background: linear-gradient(135deg, #90cdf4, #63b3ed);
            color: #1a202c;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        body.night-mode .btn:hover {
            box-shadow: 0 10px 25px rgba(144, 205, 244, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        body.night-mode .btn-danger {
            background: linear-gradient(135deg, #fc8181, #f56565);
        }

        .btn-success {
            background: linear-gradient(135deg, #26de81, #20bf6b);
        }

        body.night-mode .btn-success {
            background: linear-gradient(135deg, #68d391, #48bb78);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 350px;
            transform: translateX(400px);
            transition: all 0.5s ease;
        }

        body.night-mode .notification {
            background: #2d3748;
            color: #e2e8f0;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.break-time {
            border-left: 5px solid #ff6b6b;
        }

        .notification.eye-drop {
            border-left: 5px solid #26de81;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        body.night-mode .stat-item {
            background: rgba(144, 205, 244, 0.1);
            border: 2px solid rgba(144, 205, 244, 0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        body.night-mode .stat-number {
            color: #90cdf4;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 5px;
        }

        body.night-mode .stat-label {
            color: #a0aec0;
        }

        .eye-exercise {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        body.night-mode .eye-exercise {
            background: linear-gradient(135deg, #2d3748, #4a5568);
        }

        .eye-animation {
            width: 60px;
            height: 60px;
            background: #4a5568;
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            animation: blink 3s infinite;
        }

        body.night-mode .eye-animation {
            background: #e2e8f0;
        }

        .eye-animation::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        body.night-mode .eye-animation::before {
            background: #2d3748;
        }

        .floating-icon {
            position: fixed;
            animation: float 3s ease-in-out infinite;
            font-size: 2rem;
            opacity: 0.3;
            width: 32px;
            height: 32px;
            fill: #667eea;
        }

        body.night-mode .floating-icon {
            fill: #90cdf4;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .break-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .break-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 50px;
            border-radius: 25px;
            animation: scaleIn 0.5s ease-out;
        }

        body.night-mode .break-content {
            background: linear-gradient(135deg, #2d3748, #4a5568);
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .settings-panel {
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 8px 32px rgba(0,0,0,0.06);
        }

        body.night-mode .settings-panel {
            background: rgba(45,55,72,0.9);
            border: 1px solid rgba(74,85,104,0.3);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        body.night-mode .slider {
            background-color: #4a5568;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        body.night-mode input:checked + .slider {
            background-color: #90cdf4;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
        }

        .settings-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d3748;
        }

        body.night-mode .settings-label {
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- Floating SVG Icons -->
    <svg class="floating-icon" style="top: 10%; left: 5%;" viewBox="0 0 24 24">
        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
    </svg>
    
    <svg class="floating-icon" style="top: 20%; right: 10%;" viewBox="0 0 24 24">
        <path d="M12 3v18l4-4V7l-4-4z"/>
        <path d="M8 11v6l4 4V7l-4 4z"/>
    </svg>
    
    <svg class="floating-icon" style="bottom: 30%; left: 8%;" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12,6 12,12 16,14"/>
    </svg>

    <div class="container">
        <div class="header">
            <h1>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
                Eye Protection Schedule
            </h1>
            <p>Post C3R Recovery & Daily Screen Care</p>
        </div>

        <div class="dashboard">
            <!-- Main Timer Card -->
            <div class="card">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    Session Timer
                </h3>
                <div class="timer-display" id="sessionTimer">00:00</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="sessionProgress"></div>
                </div>
                <div style="text-align: center;">
                    <button class="btn" id="startBtn">Start Session</button>
                    <button class="btn btn-danger" id="pauseBtn">Pause</button>
                    <button class="btn" id="resetBtn">Reset</button>
                </div>
                <p style="margin-top: 15px; text-align: center; color: #718096;">
                    Next break in: <span id="nextBreak">20:00</span>
                </p>
            </div>

            <!-- Break Timer Card -->
            <div class="card">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="8" r="5"/>
                        <path d="M20.38 15.5a6 6 0 0 1-7.76 0"/>
                        <path d="M3.62 15.5a6 6 0 0 0 7.76 0"/>
                    </svg>
                    Break Timer
                </h3>
                <div class="timer-display" id="breakTimer">10:00</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="breakProgress"></div>
                </div>
                <div class="eye-exercise">
                    <div class="eye-animation"></div>
                    <p><strong>20-20-20 Rule Active</strong></p>
                    <p>Look at something 20 feet away for 20 seconds</p>
                </div>
            </div>

            <!-- Eye Drop Reminder -->
            <div class="card">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12 3v18l4-4V7l-4-4z"/>
                        <path d="M8 11v6l4 4V7l-4 4z"/>
                    </svg>
                    Eye Drop Schedule
                </h3>
                <div style="text-align: center;">
                    <div class="stat-number" id="dropCountdown">150:00</div>
                    <p>Until next eye drop</p>
                    <button class="btn btn-success" id="dropTakenBtn">
                        Drop Taken 
                        <svg class="icon" style="width: 16px; height: 16px; margin-left: 5px;" viewBox="0 0 24 24">
                            <polyline points="20,6 9,17 4,12"/>
                        </svg>
                    </button>
                </div>
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-item">
                        <div class="stat-number" id="dropsToday">0</div>
                        <div class="stat-label">Drops Today</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="lastDrop">--:--</div>
                        <div class="stat-label">Last Drop</div>
                    </div>
                </div>
            </div>

            <!-- Daily Stats -->
            <div class="card">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    Today's Progress
                </h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="screenTime">0h 0m</div>
                        <div class="stat-label">Screen Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="breaksCount">0</div>
                        <div class="stat-label">Breaks Taken</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="eyeExercises">0</div>
                        <div class="stat-label">Eye Exercises</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="healthScore">100%</div>
                        <div class="stat-label">Health Score</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <h3>
                <svg class="icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <div class="settings-item">
                    <div class="settings-label">
                        <svg class="icon" viewBox="0 0 24 24">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                        Sound Notifications
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <div class="settings-label">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                        Night Mode
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="nightModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <div class="settings-label">
                        <svg class="icon" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                        Break Reminders
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="breakRemindersToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <div class="settings-label">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 3v18l4-4V7l-4-4z"/>
                            <path d="M8 11v6l4 4V7l-4 4z"/>
                        </svg>
                        Eye Drop Alerts
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dropAlertsToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification System -->
    <div class="notification" id="notification">
        <div id="notificationContent"></div>
        <button onclick="closeNotification()" style="float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer;">Ã—</button>
    </div>

    <!-- Break Overlay -->
    <div class="break-overlay" id="breakOverlay">
        <div class="break-content">
            <h2>
                <svg class="icon" style="width: 32px; height: 32px; margin-right: 10px;" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                </svg>
                Break Time!
            </h2>
            <div class="eye-animation" style="margin: 30px auto;"></div>
            <p style="font-size: 1.2rem; margin: 20px 0;">Time for your 10-minute break</p>
            <p>Follow the 20-20-20 rule: Look at something 20 feet away for 20 seconds</p>
            <div class="timer-display" id="breakOverlayTimer">10:00</div>
            <button class="btn" onclick="startBreak()">Start Break</button>
            <button class="btn" onclick="skipBreak()">Skip Break</button>
        </div>
    </div>

    <div class="settings-item">
    <div class="settings-label">
        <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 3v18l4-4V7l-4-4z"/>
            <path d="M8 11v6l4 4V7l-4 4z"/>
        </svg>
        GitHub Sync Token
    </div>
    <input type="password" id="githubToken" placeholder="Enter GitHub token" 
           value="" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
    <button class="btn" id="saveTokenBtn" style="margin-left: 10px;">Save</button>
    <p style="font-size: 0.8rem; margin-top: 5px;">
        <a href="https://github.com/settings/tokens/new?scopes=repo&description=Eye+Protection+App" 
           target="_blank">Create token</a>
    </p>
</div>

    <script>
        class GitHubDataStorage {
            constructor(repoOwner, repoName, dataFilePath, token) {
                this.repoOwner = repoOwner;
                this.repoName = repoName;
                this.dataFilePath = dataFilePath;
                this.token = token;
                this.baseUrl = 'https://api.github.com';
            }

            async saveData(data) {
    try {
        // First get the current SHA of the file
        const getResponse = await fetch(
            `${this.baseUrl}/repos/${this.repoOwner}/${this.repoName}/contents/${this.dataFilePath}`,
            {
                headers: {
                    'Authorization': `token ${this.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            }
        );

        let sha = null;
        if (getResponse.ok) {
            const fileInfo = await getResponse.json();
            sha = fileInfo.sha;
        }

        // Update the file
        const updateResponse = await fetch(
            `${this.baseUrl}/repos/${this.repoOwner}/${this.repoName}/contents/${this.dataFilePath}`,
            {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${this.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Update eye protection data',
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(data)))),
                    sha: sha
                })
            }
        );

        if (!updateResponse.ok) {
            throw new Error('Failed to update file');
        }
        
        return await updateResponse.json();
    } catch (error) {
        console.error('Error saving data:', error);
        // Fallback to localStorage
        localStorage.setItem('eyeProtectionData', JSON.stringify(data));
        throw error;
    }
}

            async loadData() {
                try {
                    const response = await fetch(
                        `${this.baseUrl}/repos/${this.repoOwner}/${this.repoName}/contents/${this.dataFilePath}`,
                        {
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (response.ok) {
                        const fileInfo = await response.json();
                        return JSON.parse(decodeURIComponent(escape(atob(fileInfo.content))));
                    }
                    throw new Error('Failed to load file');
                } catch (error) {
                    console.error('Error loading data:', error);
                    // Fallback to localStorage
                    const localData = localStorage.getItem('eyeProtectionData');
                    return localData ? JSON.parse(localData) : null;
                }
            }
        }

        class EyeProtectionScheduler {
            constructor() {
                this.sessionTime = 0;
                this.breakTime = 0;
                this.dropCountdown = 9000;
                this.isRunning = false;
                this.isOnBreak = false;
                this.lastDropTime = null;
                this.stats = {
                    screenTime: 0,
                    breaksCount: 0,
                    eyeExercises: 0,
                    dropsToday: 0
                };
                this.settings = {
                    sound: true,
                    nightMode: false,
                    breakReminders: true,
                    dropAlerts: true,
                    githubToken: ''
                };
                
                // GitHub integration settings
                this.repoOwner = 'thame-es';
                this.repoName = 'eye-protection';
                this.dataFilePath = 'eye-protection-data.json';
                this.storage = null;
                
                this.initializeElements();
                this.bindEvents();
                this.loadSettings();
                this.initializeStorage();
                this.startTimers();
            }

            async initializeStorage() {
                if (this.settings.githubToken) {
                    this.storage = new GitHubDataStorage(
                        this.repoOwner,
                        this.repoName,
                        this.dataFilePath,
                        this.settings.githubToken
                    );
                    
                    try {
                        const data = await this.storage.loadData();
                        if (data) {
                            this.loadData(data);
                            this.showNotification('Data loaded from cloud', 'success');
                        } else {
                            this.loadLocalData();
                        }
                    } catch (error) {
                        this.loadLocalData();
                    }
                } else {
                    this.loadLocalData();
                }
            }

            loadData(data) {
                this.stats = data.stats || this.stats;
                this.sessionTime = data.sessionTime || 0;
                this.breakTime = data.breakTime || 0;
                this.dropCountdown = data.dropCountdown || 9000;
                this.isRunning = data.isRunning || false;
                this.isOnBreak = data.isOnBreak || false;
                this.lastDropTime = data.lastDropTime ? new Date(data.lastDropTime) : null;
                
                if (data.settings) {
                    this.settings = {...this.settings, ...data.settings};
                    this.loadSettings();
                }
                
                this.updateSessionDisplay();
                this.updateBreakDisplay();
                this.updateDropDisplay();
                this.updateStats();
                
                if (this.lastDropTime) {
                    this.elements.lastDrop.textContent = this.lastDropTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                if (this.isRunning) {
                    this.elements.startBtn.textContent = 'Pause Session';
                    this.elements.startBtn.className = 'btn btn-danger';
                }
            }

            loadLocalData() {
                const savedData = localStorage.getItem('eyeProtectionData');
                if (savedData) {
                    this.loadData(JSON.parse(savedData));
                }
            }

            async saveData() {
    const data = {
        stats: this.stats,
        sessionTime: this.sessionTime,
        breakTime: this.breakTime,
        dropCountdown: this.dropCountdown,
        isRunning: this.isRunning,
        isOnBreak: this.isOnBreak,
        lastDropTime: this.lastDropTime,
        settings: this.settings,
        lastUpdated: new Date().toISOString()
    };

    // Always save to localStorage as fallback
    localStorage.setItem('eyeProtectionData', JSON.stringify(data));

    if (!this.storage || !this.storage.token) {
        this.showNotification('Saved locally (no cloud token configured)', 'warning');
        return;
    }

    try {
        // First try to get the existing file to obtain SHA (if it exists)
        let sha = null;
        try {
            const getResponse = await fetch(
                `${this.storage.baseUrl}/repos/${this.storage.repoOwner}/${this.storage.repoName}/contents/${this.storage.dataFilePath}`,
                {
                    headers: {
                        'Authorization': `token ${this.storage.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }
            );

            if (getResponse.ok) {
                const fileInfo = await getResponse.json();
                sha = fileInfo.sha;
            } else if (getResponse.status !== 404) {
                throw new Error(`GitHub API error: ${getResponse.status}`);
            }
        } catch (getError) {
            console.warn('Failed to check existing file:', getError);
            // Continue anyway - we'll try to create new file
        }

        // Prepare the update
        const updateData = {
            message: 'Update eye protection data',
            content: btoa(unescape(encodeURIComponent(JSON.stringify(data)))),
            sha: sha // Will be null for new files
            };

        // Attempt to create/update the file
        const updateResponse = await fetch(
            `${this.storage.baseUrl}/repos/${this.storage.repoOwner}/${this.storage.repoName}/contents/${this.storage.dataFilePath}`,
            {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${this.storage.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            }
        );

        if (!updateResponse.ok) {
            const errorData = await updateResponse.json().catch(() => ({}));
            throw new Error(`Failed to save: ${updateResponse.status} - ${errorData.message || 'Unknown error'}`);
        }

        this.showNotification('Data successfully saved to cloud', 'success');
        return await updateResponse.json();
        
    } catch (error) {
        console.error('Cloud save failed:', error);
        this.showNotification(`Saved locally (cloud error: ${error.message})`, 'warning');
        // Still throw the error so calling code knows it failed
        throw error;
    }
}

            initializeElements() {
                this.elements = {
                    sessionTimer: document.getElementById('sessionTimer'),
                    breakTimer: document.getElementById('breakTimer'),
                    dropCountdown: document.getElementById('dropCountdown'),
                    sessionProgress: document.getElementById('sessionProgress'),
                    breakProgress: document.getElementById('breakProgress'),
                    nextBreak: document.getElementById('nextBreak'),
                    startBtn: document.getElementById('startBtn'),
                    pauseBtn: document.getElementById('pauseBtn'),
                    resetBtn: document.getElementById('resetBtn'),
                    dropTakenBtn: document.getElementById('dropTakenBtn'),
                    screenTime: document.getElementById('screenTime'),
                    breaksCount: document.getElementById('breaksCount'),
                    eyeExercises: document.getElementById('eyeExercises'),
                    dropsToday: document.getElementById('dropsToday'),
                    lastDrop: document.getElementById('lastDrop'),
                    healthScore: document.getElementById('healthScore')
                };
            }

            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.toggleSession());
                this.elements.pauseBtn.addEventListener('click', () => this.pauseSession());
                this.elements.resetBtn.addEventListener('click', () => this.resetSession());
                this.elements.dropTakenBtn.addEventListener('click', () => this.dropTaken());
                
                document.getElementById('soundToggle').addEventListener('change', (e) => {
                    this.settings.sound = e.target.checked;
                    this.saveSettings();
                });
                
                document.getElementById('nightModeToggle').addEventListener('change', (e) => {
                    this.settings.nightMode = e.target.checked;
                    document.body.classList.toggle('night-mode', e.target.checked);
                    this.saveSettings();
                });
                
                document.getElementById('breakRemindersToggle').addEventListener('change', (e) => {
                    this.settings.breakReminders = e.target.checked;
                    this.saveSettings();
                });
                
                document.getElementById('dropAlertsToggle').addEventListener('change', (e) => {
                    this.settings.dropAlerts = e.target.checked;
                    this.saveSettings();
                });
                
                document.getElementById('saveTokenBtn').addEventListener('click', async () => {
                    const token = document.getElementById('githubToken').value.trim();
                    if (token) {
                        this.settings.githubToken = token;
                        await this.saveSettings();
                        this.initializeStorage();
                        this.showNotification('GitHub token saved!', 'success');
                    }
                });
            }

            async saveSettings() {
                localStorage.setItem('eyeProtectionSettings', JSON.stringify(this.settings));
                await this.saveData();
            }

            loadSettings() {
                const savedSettings = localStorage.getItem('eyeProtectionSettings');
                if (savedSettings) {
                    this.settings = {...this.settings, ...JSON.parse(savedSettings)};
                }
                
                document.getElementById('soundToggle').checked = this.settings.sound;
                document.getElementById('nightModeToggle').checked = this.settings.nightMode;
                document.getElementById('breakRemindersToggle').checked = this.settings.breakReminders;
                document.getElementById('dropAlertsToggle').checked = this.settings.dropAlerts;
                document.getElementById('githubToken').value = this.settings.githubToken || '';
                
                if (this.settings.nightMode) {
                    document.body.classList.add('night-mode');
                }
            }

            startTimers() {
                setInterval(() => {
                    if (this.isRunning && !this.isOnBreak) {
                        this.sessionTime++;
                        this.stats.screenTime++;
                        this.updateSessionDisplay();
                        
                        if (this.sessionTime % 1200 === 0 && this.sessionTime > 0) {
                            this.triggerBreak();
                        }
                    }
                    
                    if (this.isOnBreak) {
                        this.breakTime--;
                        this.updateBreakDisplay();
                        
                        if (this.breakTime <= 0) {
                            this.endBreak();
                        }
                    }
                    
                    this.dropCountdown--;
                    this.updateDropDisplay();
                    
                    if (this.dropCountdown <= 0 && this.settings.dropAlerts) {
                        this.showNotification('Time for your eye drops!', 'eye-drop');
                        this.dropCountdown = 9000;
                    }
                    
                    this.updateStats();
                }, 1000);
            }

            async toggleSession() {
                this.isRunning = !this.isRunning;
                this.elements.startBtn.textContent = this.isRunning ? 'Pause Session' : 'Start Session';
                this.elements.startBtn.className = this.isRunning ? 'btn btn-danger' : 'btn';
                
                if (this.isRunning) {
                    this.playSound('start');
                }
                await this.saveData();
            }

            async pauseSession() {
                this.isRunning = false;
                this.elements.startBtn.textContent = 'Resume Session';
                this.elements.startBtn.className = 'btn';
                await this.saveData();
            }

            async resetSession() {
                this.sessionTime = 0;
                this.isRunning = false;
                this.elements.startBtn.textContent = 'Start Session';
                this.elements.startBtn.className = 'btn';
                this.updateSessionDisplay();
                await this.saveData();
            }

            async triggerBreak() {
                if (!this.settings.breakReminders) return;
                
                this.isOnBreak = true;
                this.breakTime = 600;
                this.stats.breaksCount++;
                
                this.showBreakOverlay();
                this.showNotification('Break Time! Take a 10-minute break for your eyes.', 'break-time');
                this.playSound('break');
                
                await this.saveData();
            }

            async startBreak() {
                document.getElementById('breakOverlay').style.display = 'none';
                this.stats.eyeExercises++;
                await this.saveData();
            }

            async skipBreak() {
                this.endBreak();
                document.getElementById('breakOverlay').style.display = 'none';
                await this.saveData();
            }

            endBreak() {
                this.isOnBreak = false;
                this.breakTime = 0;
                this.updateBreakDisplay();
            }

            async dropTaken() {
                this.dropCountdown = 9000;
                this.stats.dropsToday++;
                this.lastDropTime = new Date();
                this.elements.lastDrop.textContent = this.lastDropTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                this.showNotification('Eye drop recorded!', 'eye-drop');
                this.playSound('success');
                await this.saveData();
            }

            /* [Keep all your existing display update methods] */
           updateSessionDisplay() {
                const hours = Math.floor(this.sessionTime / 3600);
                const minutes = Math.floor((this.sessionTime % 3600) / 60);
                const seconds = this.sessionTime % 60;
                
                this.elements.sessionTimer.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Progress bar (20 minutes = 100%)
                const progress = ((this.sessionTime % 1200) / 1200) * 100;
                this.elements.sessionProgress.style.width = progress + '%';
                
                // Next break countdown
                const nextBreakSeconds = 1200 - (this.sessionTime % 1200);
                const nextBreakMinutes = Math.floor(nextBreakSeconds / 60);
                const remainingSeconds = nextBreakSeconds % 60;
                this.elements.nextBreak.textContent = 
                    `${nextBreakMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
            
            updateBreakDisplay() {
                const minutes = Math.floor(this.breakTime / 60);
                const seconds = this.breakTime % 60;
                
                this.elements.breakTimer.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = ((600 - this.breakTime) / 600) * 100;
                this.elements.breakProgress.style.width = progress + '%';
                
                // Update overlay timer if visible
                const overlayTimer = document.getElementById('breakOverlayTimer');
                if (overlayTimer) {
                    overlayTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }
            
            updateDropDisplay() {
                const hours = Math.floor(this.dropCountdown / 3600);
                const minutes = Math.floor((this.dropCountdown % 3600) / 60);
                
                this.elements.dropCountdown.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
            
           updateStats() {
                const screenHours = Math.floor(this.stats.screenTime / 3600);
                const screenMinutes = Math.floor((this.stats.screenTime % 3600) / 60);
                
                this.elements.screenTime.textContent = `${screenHours}h ${screenMinutes}m`;
                this.elements.breaksCount.textContent = this.stats.breaksCount;
                this.elements.eyeExercises.textContent = this.stats.eyeExercises;
                this.elements.dropsToday.textContent = this.stats.dropsToday;
                
                // Calculate health score
                const expectedBreaks = Math.floor(this.stats.screenTime / 1200);
                const breakScore = expectedBreaks > 0 ? Math.min((this.stats.breaksCount / expectedBreaks) * 100, 100) : 100;
                const dropScore = this.stats.dropsToday >= Math.ceil(this.stats.screenTime / 3600) ? 100 : 
                                 (this.stats.dropsToday / Math.ceil(this.stats.screenTime / 3600)) * 100;
                
                const healthScore = Math.floor((breakScore + dropScore) / 2);
                this.elements.healthScore.textContent = healthScore + '%';
                this.elements.healthScore.style.color = healthScore >= 80 ? '#26de81' : 
                                                       healthScore >= 60 ? '#f39c12' : '#ff6b6b';
            }
            
            showNotification(message, type = '') {
                const notification = document.getElementById('notification');
                const content = document.getElementById('notificationContent');
                
                content.innerHTML = `<strong>${message}</strong>`;
                notification.className = `notification show ${type}`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }
            
            showBreakOverlay() {
                document.getElementById('breakOverlay').style.display = 'flex';
            }
            
            playSound(type) {
                if (!this.settings.sound) return;
                
                // Create audio context and play different tones
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                const frequencies = {
                    start: 440,
                    break: 523,
                    success: 659
                };
                
                oscillator.frequency.value = frequencies[type] || 440;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        // Initialize the scheduler when page loads
        let scheduler;
        document.addEventListener('DOMContentLoaded', async () => {
            scheduler = new EyeProtectionScheduler();
        });

        // Global functions for overlay buttons
        async function startBreak() {
            await scheduler.startBreak();
        }

        async function skipBreak() {
            await scheduler.skipBreak();
        }

        function closeNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>